<!DOCTYPE html>
<html>
  <head>
    <title>ECSY Particles</title>
    <style>
      html,
      body {
        margin: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }
    </style>
    <script defer type="module">
      import * as THREE from "three"
      import * as ECSY from "ecsy"
      import * as ECSYTHREE from "ecsy-three"
      import * as ECSYTHREEX from "ecsy-three/extras"
      import * as PARTICLES from "../dist/ecsy-particles.js"
      import { OrbitControls } from "three/examples/jsm/controls/OrbitControls"

      const DEG2RAD = THREE.MathUtils.DEG2RAD
      const COUNT = 20

      /** Firework **/
      class Firework extends ECSY.Component {}
      Firework.schema = {
        radialSpeed: { type: ECSY.Types.Number, default: 2 },
        y: { type: ECSY.Types.Number, default: 1 },
        z: { type: ECSY.Types.Number, default: 1 }
      }

      class FireworkSystem extends ECSY.System {
        execute(dt, t) {
          for (let entity of this.queries.translating.results) {
            const translating = entity.getComponent(Firework)
            /** @type {ECSYTHREEX.Transform} */
            const transform = entity.getMutableComponent(ECSYTHREEX.Transform)
            transform.position.y += 0.01
            transform.position.z = Math.random() / 100
          }
        }
      }

      FireworkSystem.queries = {
        translating: {
          components: [Firework, ECSYTHREEX.Transform]
        }
      }
      const world = new ECSYTHREE.ECSYThreeWorld()
        // .registerSystem(ECSYTHREE.VRControllerSystem)
        .registerSystem(FireworkSystem)
        .registerComponent(ECSYTHREEX.Transform)
        .registerComponent(Firework)

      PARTICLES.initializeParticleSystem(world)

      const data = ECSYTHREEX.initialize(world, { vr: false })

      const { scene, renderer, camera } = data.entities

      // for (let id = 0; id <= 1; id++) {
      //   world
      //     .createEntity()
      //     // .addComponent(ECSYTHREE.VRController, { id })
      //     .addComponent(ECSYTHREEX.Parent, { value: scene })
      // }

      const cam = camera.getComponent(ECSYTHREE.Object3DComponent)["value"]
      cam.position.set(-1, 0.5, -1).multiplyScalar(0.5)
      cam.lookAt(new THREE.Vector3())

      setTimeout(() => {
        const domElement = document.body.querySelector("canvas")
        const controls = new OrbitControls(cam, domElement)
      }, 0)

      const coneGeo = new THREE.ConeBufferGeometry()
      const coneMesh = new THREE.Mesh(
        coneGeo,
        new THREE.MeshStandardMaterial({ color: "pink" })
      )
      const coneParticleMesh = PARTICLES.createParticleMesh({
        mesh: coneMesh,
        style: "mesh",
        particleCount: 2000
      })
      const sharedParticleMesh = PARTICLES.createParticleMesh({
        texture: "assets/spritesheet.png",
        particleCount: 20000,
        alphaTest: 0.01,
        useBrownianMotion: true,
        useVelocityScale: true,
        transparent: true,
        depthWrite: false
      })
      const scene3D = scene.getComponent(ECSYTHREE.Object3DComponent)["value"]

      scene3D.add(new THREE.AxesHelper())
      scene3D.add(new THREE.GridHelper(2, 1))
      scene3D.add(new THREE.AmbientLight(0x404040))
      scene3D.add(new THREE.DirectionalLight())
      scene3D.add(sharedParticleMesh)
      scene3D.add(coneParticleMesh)

      console.log("sharedParticleMesh", sharedParticleMesh)

      /** Create Geometry Figure**/

      const geometry = new THREE.SphereGeometry(1.25, 8, 8)
      const material = new THREE.MeshBasicMaterial({ color: 0x5c53ff })
      const circleGeometry = new THREE.Mesh(geometry, material)
      circleGeometry.scale.x = 0.08
      circleGeometry.scale.y = 0.08
      circleGeometry.scale.z = 0.08

      /** End **/

      for (let i = 0; i < COUNT; i++) {
        setTimeout(() => {
          const object = world
            .createEntity()
            .addObject3DComponent(circleGeometry.clone(), scene)
            .addComponent(Firework, {
              speed: 1,
              z: i
            })
            .addComponent(ECSYTHREEX.Transform, {
              position: { x: 0, y: 0, z: 0 },
              rotation: { x: 0, y: 0, z: 0 }
            })
            .addComponent(ECSYTHREEX.Parent, { value: scene })

          world
            .createEntity()
            .addComponent(PARTICLES.ParticleEmitter, {
              particleMesh: sharedParticleMesh,
              atlas: "fireworks_sheet.png",
              textureFrame: { cols: 5, rows: 5 },
              count: 1,
              lifeTime: 5,
              scales: [0, 15],
              syncTransform: true
            })
            .addComponent(ECSYTHREEX.Transform, {
              position: { x: 0, y: 0, z: 0 },
              rotation: { x: 0, y: 0, z: 0 }
            })
            .addComponent(ECSYTHREEX.Parent, { value: object })
        }, 3000 * i)
      }

      world.execute(0.000001, 0.000001)

      // set the background color, must be after the first execute
      // const renderer3D = renderer.getComponent(ECSYTHREE.WebGLRendererContext).value;
      // renderer3D.setClearColor(new THREE.Color(0x111111), 1.)
    </script>
  </head>
  <body></body>
</html>
