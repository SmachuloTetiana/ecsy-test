<!DOCTYPE html>
<html>
  <head>
    <title>ECSY Particles</title>
    <style>
      html,
      body {
        margin: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }
    </style>
    <script defer type="module">
      import * as THREE from "three"
      import * as ECSY from "ecsy"
      import * as ECSYTHREE from "ecsy-three"
      import * as ECSYTHREEX from "ecsy-three/extras"
      import * as PARTICLES from "../dist/ecsy-particles.js"
      import { OrbitControls } from "three/examples/jsm/controls/OrbitControls"

      const DEG2RAD = THREE.MathUtils.DEG2RAD
      const COUNT = 20

      /** Firework **/
      class Firework extends ECSY.Component {}
      Firework.schema = {
        x: { type: ECSY.Types.Number, default: 0 },
        y: { type: ECSY.Types.Number, default: 0 },
        z: { type: ECSY.Types.Number, default: 0 }
      }

      class FireworkSystem extends ECSY.System {
        execute(dt, t) {
          for (let entity of this.queries.translating.results) {
            const translating = entity.getComponent(Firework)
            /** @type {ECSYTHREEX.Transform} */
            const transform = entity.getMutableComponent(ECSYTHREEX.Transform)
            const acc = entity.getComponent(PARTICLES.ParticleEmitter)

            if (transform.position.y < 2) {
              transform.position.x += translating.x
              transform.position.y += translating.y
              transform.position.z += translating.z
            } else {
              entity.remove()
            }

            console.log(entity)
          }
        }
      }

      FireworkSystem.queries = {
        translating: {
          components: [Firework, ECSYTHREEX.Transform]
        }
      }
      const world = new ECSYTHREE.ECSYThreeWorld()
        // .registerSystem(ECSYTHREE.VRControllerSystem)
        .registerSystem(FireworkSystem)
        .registerComponent(ECSYTHREEX.Transform)
        .registerComponent(Firework)

      PARTICLES.initializeParticleSystem(world)

      const data = ECSYTHREEX.initialize(world, { vr: false })

      const { scene, renderer, camera } = data.entities

      const cam = camera.getComponent(ECSYTHREE.Object3DComponent)["value"]
      cam.position.set(-1, 0.5, -1).multiplyScalar(1)
      cam.lookAt(new THREE.Vector3())

      setTimeout(() => {
        const domElement = document.body.querySelector("canvas")
        const controls = new OrbitControls(cam, domElement)
      }, 0)

      const sharedParticleMesh = PARTICLES.createParticleMesh({
        texture: "assets/spritesheet.png",
        particleCount: 20000,
        alphaTest: 0.01,
        useBrownianMotion: true,
        useVelocityScale: true,
        transparent: true,
        depthWrite: false
      })
      const scene3D = scene.getComponent(ECSYTHREE.Object3DComponent)["value"]

      scene3D.add(new THREE.AxesHelper())
      scene3D.add(new THREE.GridHelper(2, 1))
      scene3D.add(new THREE.AmbientLight(0x404040))
      scene3D.add(new THREE.DirectionalLight())
      scene3D.add(sharedParticleMesh)

      console.log("sharedParticleMesh", sharedParticleMesh)

      /** Create Geometry Figure**/

      const geometry = new THREE.SphereGeometry(1.25, 8, 8)
      const material = new THREE.MeshBasicMaterial({ color: 0x5c53ff })
      const circleGeometry = new THREE.Mesh(geometry, material)
      circleGeometry.scale.x = 0.08
      circleGeometry.scale.y = 0.08
      circleGeometry.scale.z = 0.08

      /** End **/

      const tail = world
        .createEntity("tail")
        .addComponent(PARTICLES.ParticleEmitter, {
          particleMesh: sharedParticleMesh,
          atlas: "blob.png",
          count: 100,
          lifeTime: 2,
          colors: [new THREE.Color(0x655cfe)],
          scales: [2, 0],
          syncTransform: true
        })
        .addComponent(ECSYTHREEX.Transform, {})
        .addComponent(Firework, { x: 0, y: 0.01, z: 0.01 })
        .addComponent(ECSYTHREEX.Parent, { value: scene })

      world
        .createEntity("explosion")
        .addComponent(PARTICLES.ParticleEmitter, {
          particleMesh: sharedParticleMesh,
          atlas: "blob.png",
          count: 200,
          lifeTime: 4,
          colors: [new THREE.Color(0x655cfe)],
          scales: [1],
          // opacities: [0],
          burst: 1,
          radialAcceleration: 0.3,
          syncTransform: true
        })
        .addComponent(ECSYTHREEX.Transform, {
          position: { x: 0, y: 2, z: 2 }
        })

      world.execute(0.000001, 0.000001)

      // set the background color, must be after the first execute
      // const renderer3D = renderer.getComponent(ECSYTHREE.WebGLRendererContext).value;
      // renderer3D.setClearColor(new THREE.Color(0x111111), 1.)
    </script>
  </head>
  <body></body>
</html>
